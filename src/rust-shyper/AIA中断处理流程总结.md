## AIA中断处理流程

------

**目录**

[TOC]

### 1. MSI中断处理流程

假设要向 hart[i]发送 MSI 中断,设操作系统给该中断源分配的中断向量号为EIID,中断处理流程如下:

#### 1.1 配置

1. 配置中断阈值：向 hart[i]的 IMSIC 模块 中的 eithreshold 寄存器写入阈值 
2. 打开对应 EIID 的中断使能位: 将 hart [i]的 IMSIC 模块中的 eie 寄存器中对应编号 EIID 的 bit 位设置“1”。

####  1.2 MSI中断的产生

以 PCIe 设备的 MSI 中断为例,将位于 hart [x]的相应 IMSIC 单元的 seteipnum_le 寄存器的地址填入到 PCIe 设备的 Message Address 字段, 则 PCIe 发送的 MSI 中断将被传送到 hart[x]的相 应 IMSIC 单元,将由 hart[x]来响应该 MSI 中断。 

处理器间中断 IPI,如果线程 i 要与线 程 j 通信,则线程 i 的程序查找对应 hart [ j] 的 seteipnum_le 寄存器的地址,向该地址发送 MSI 中断。

#### 1.3 中断传递和处理：

IMSIC 的中断文件向连接的硬件线程发送外 部中断请求信号,每个中断文件发送一个中断请求信号。处理器核响应中断后,首先执行统一的专门用于处理通过 IMSIC 进行的外部中断的处理程序(其入口地址由处理器核的设计决定)。 该 中断处理程序为所有外部中断共有,由操作系统内核或裸机系统驱动提供,可以大致按照如下步骤编写:

1. 保存处理器核寄存器上下文
2. i = 读取 CSR mtopei 或 stopei,并同时写该寄存器来 认领中断,一般使用 CSRRW 指令来完成该操作
3. 获取中断 ID 号: i = i > > 16
4. 调用外部中断 i 的中断服务程序
5. 恢复处理器核寄存器上下文
6. return from trap

在本例中,当 imsic 接收到的中断请求中没 有比该中断源优先级更高的中断时,则步骤 2 读 取的∗topei 值右移 16 位将为 EIID,其中第 3 步 将调用的是对应中断向量号为 EIID 的中断处理 程序。

###  2. 有线中断处理流程

用一个例子来阐述有线中断的处理流程,假 设 uart0 设备要向 hart[ i]发中断请求,设操作系 统或裸机系统驱动程序给该 uart0 设备分配的中 断向量号为 EIID,中断处理流程如下:

#### 2.1 配置APLIC

1. 配置 uart0 设备的中断源模式 

假设从中断控制器设计文档中的中断源编号 表中查找到 uart0 对应的编号为 24(由于是有线 中断,该编号值由硬件设计时的中断源连线决 定),查找 RISC-V AIA 的 APLIC 寄存器规范得知 向 sourcecfg 寄存器的源模式域写入 6 代表高电 平触 发 模 式, 然 后 向 APLIC 模 块 中 的 寄 存 器 sourcecfg[24]写入 6。

2. 打开 uart0 设备中断源在 APLIC 模块中 的使能位

向 APLIC 模 块 中 的 setienum 寄 存 器 写 入 uart0 的编号 24

3. 设置 uart0 的中断发给哪个 hart,以及对 应系统分配给 uart0 的中断 ID 号

向 APLIC 模块中的寄存器 target [24] 写入 hart 索引号和 uart0 的中断向量号。 设 EIID 为 系统分配给 uart0 的中断向量 ID 号

#### 2.2 配置IMSIC

1. 配置中断阈值: 向 hart[i]的 IMSIC 模块 中的 eithreshold 寄存器写入阈值 et。

2. 打开编号为 EI _ID 的中断使能位: 将 hart[i]的 IMSIC 模块中的 eie 寄存器中对应编号 EIID 的 bit 位设置“1”

#### 2.3 uart0 触发中断,处理器核响应中断

uart0 设备触发中断后,经由 APLIC 单元将中 断传输给 IMSIC 单元,再由 IMSIC 单元向处理器核发送中断请求信号。 处理器核响应中断后,首先执行前文 MSI 中断处理中统一的 RISC-V AIA 外部中断服务程序。

在本例中,当 IMSIC 接收到的中断请求中没 有比 uart0 优先级更高的中断时,则前文 RISC-V AIA 外部中断服务程序算法步骤的第 2 步读出的 topei 值右移 16 位将为 uart0 的中断 ID 号 EI_ ID,其中第 4 步将调用的是 uart0 的中断服务 程序。

在发送 MSI 时清除挂起位显然是必要的,以 避免同一中断从 APLIC 向目标 IMSIC 重复发 MSI 中断。 但是,在中断服务程序解决了产生的中断 原因之后,传入中断线可能会出于其他原因在 APLIC 上保持置位状态(尽管 APLIC 上的中断挂 起位已被清除,并且无需软件干预即可保持此状 态)。 如果中断服务程序随后退出而不采取进一 步操作,则来自此源的后续中断可能永远不会引 起注意。

为了避免以这种方式丢弃中断,电平敏感 中断的中断服务程序在退出之前执行以下操 作: 通过在 APLIC 上读取相应的 in_clrip 寄存 器来测试进入 APLIC 的中断线是否仍然被置 位。 如果仍然被置位,则可以重复执行中断服 务程序的设备中断处理,以在再次测试中断源 线路之前查找并解决其他中断原因。 一旦观察 到中断源传入线路未置位,中断服务程序可以 安全退 出,因 为 任 何 新 产 生 的 中 断 都 将 导 致 pending 位被设置,并将新的 MSI 发送到目标硬 件线程。 
